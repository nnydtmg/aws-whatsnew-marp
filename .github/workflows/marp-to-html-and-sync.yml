name: Generate HTML and Update Metadata

on:
  push:
    branches: [main]
  schedule:
    # 毎日 0:00 UTC (日本時間 9:00) に実行
    - cron: '0 0 * * *'
  workflow_dispatch: # 手動実行を許可

permissions:
  contents: write     # リポジトリ内容: read/write/none (pushするためwriteが必要)
  issues: write       # Issues: read/write/none
  pull-requests: write # PR: read/write/none

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Marp CLIでHTMLを生成
      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Generate slide.html from slide.md
        run: |
          converted_count=0
          skipped_count=0

          if [ "${{ github.event_name }}" = "push" ]; then
            # pushイベント: 変更されたファイルのみ処理
            echo "Processing only changed files..."
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                dir=$(dirname "$file")
                echo "  ✓ Converting $file..."
                marp --html --allow-local-files "$file" -o "$dir/slide.html"
                converted_count=$((converted_count + 1))
              fi
            done < <(git diff --name-only HEAD^ HEAD | grep 'slide\.md$')
          else
            # schedule または workflow_dispatch: HTMLが存在しないファイルのみ処理
            echo "Processing slide.md files without HTML..."
            while IFS= read -r file; do
              dir=$(dirname "$file")
              html_file="$dir/slide.html"
              if [ ! -f "$html_file" ]; then
                echo "  ✓ Converting $file..."
                marp --html --allow-local-files "$file" -o "$html_file"
                converted_count=$((converted_count + 1))
              else
                echo "  - Skipping $file (HTML already exists)"
                skipped_count=$((skipped_count + 1))
              fi
            done < <(find . -type f -name "slide.md")
          fi

          echo ""
          echo "=== Conversion Summary ==="
          echo "Converted: $converted_count file(s)"
          echo "Skipped:   $skipped_count file(s)"

      # メタデータを生成（全てのKVキー）
      - name: Generate metadata
        run: |
          node .github/scripts/generate-metadata.mjs . all > metadata-all.json
          echo "Generated metadata for $(cat metadata-all.json | jq -r '."metadata:index".totalCount') articles"

      # Wrangler CLIでKVを更新
      - name: Update Workers KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g wrangler

          # metadata:index を更新
          cat metadata-all.json | jq '."metadata:index"' | \
            wrangler kv key put "metadata:index" \
              --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
              --remote \
              --path=/dev/stdin

          # metadata:months を更新
          cat metadata-all.json | jq '."metadata:months"' | \
            wrangler kv key put "metadata:months" \
              --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
              --remote \
              --path=/dev/stdin

          # 各月のメタデータを更新
          cat metadata-all.json | jq -r 'keys[] | select(startswith("metadata:") and (. != "metadata:index") and (. != "metadata:months"))' | while read key; do
            echo "Updating $key..."
            cat metadata-all.json | jq ".\"$key\"" | \
              wrangler kv key put "$key" \
                --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
                --remote \
                --path=/dev/stdin
          done

      # HTMLファイルをコミット
      - name: Commit generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "**/slide.html" metadata-all.json
          git diff --quiet && git diff --staged --quiet || \
            git commit -m "Generate HTML and metadata [skip ci]"
          git push