name: Generate HTML and Update Metadata

on:
  schedule:
    # 毎日 0:00 UTC (日本時間 9:00) に実行
    - cron: '0 0 * * *'
  workflow_dispatch: # 手動実行を許可

permissions:
  contents: write     # リポジトリ内容: read/write/none (pushするためwriteが必要)
  issues: write       # Issues: read/write/none
  pull-requests: write # PR: read/write/none

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Marp CLIでHTMLを生成
      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Generate slide.html from slide.md
        run: |
          converted_count=0
          skipped_count=0
          failed_count=0
          converted_files=""
          skipped_files=""
          failed_files=""

          echo "Processing slide.md files without HTML..."
          mapfile -d '' files < <(find . -type f -name "slide.md" -print0)
          for file in "${files[@]}"; do
            dir=$(dirname "$file")
            html_file="$dir/slide.html"
            if [ ! -f "$html_file" ]; then
              echo "  ✓ Converting $file..."
              if marp --html --allow-local-files "$file" -o "$html_file" < /dev/null; then
                converted_count=$((converted_count + 1))
                converted_files="${converted_files}\n  - ${file}"
              else
                echo "  ✗ Failed to convert $file"
                failed_count=$((failed_count + 1))
                failed_files="${failed_files}\n  - ${file}"
              fi
            else
              echo "  - Skipping $file (HTML already exists)"
              skipped_count=$((skipped_count + 1))
              skipped_files="${skipped_files}\n  - ${file}"
            fi
          done

          echo ""
          echo "=== Conversion Summary ==="
          echo "Converted: $converted_count file(s)"
          echo "Skipped:   $skipped_count file(s)"
          echo "Failed:    $failed_count file(s)"
          if [ "$converted_count" -gt 0 ]; then
            echo ""
            echo "Converted files:"
            printf "%b\n" "$converted_files"
          fi
          if [ "$skipped_count" -gt 0 ]; then
            echo ""
            echo "Skipped files:"
            printf "%b\n" "$skipped_files"
          fi
          if [ "$failed_count" -gt 0 ]; then
            echo ""
            echo "Failed files:"
            printf "%b\n" "$failed_files"
          fi

      # サムネイル生成（各スライドの1枚目をPNG化）
      - name: Generate thumbnails from slide.md
        run: |
          set +e
          shopt -s nullglob

          generated_count=0
          skipped_count=0
          failed_count=0
          generated_files=""
          skipped_files=""
          failed_files=""

          mapfile -d '' files < <(find . -type f -name "slide.md" -print0)
          for file in "${files[@]}"; do
            dir=$(dirname "$file")
            summary_md="$dir/summary.md"
            slide_html="$dir/slide.html"
            if [ -f "$summary_md" ] && [ -f "$slide_html" ]; then
              echo "Generating thumbnail for $file..."
              if marp --image png --allow-local-files "$file" -o "$dir/thumbnail.png" < /dev/null; then
                generated_count=$((generated_count + 1))
                generated_files="${generated_files}\n  - ${file}"
              else
                echo "  ✗ Failed to convert $file"
                failed_count=$((failed_count + 1))
                failed_files="${failed_files}\n  - ${file}"
              fi
            else
              echo "Skipping $file (missing summary.md or slide.html)"
              skipped_count=$((skipped_count + 1))
              skipped_files="${skipped_files}\n  - ${file}"
            fi
          done

          echo ""
          echo "=== Thumbnail Summary ==="
          echo "Generated: $generated_count file(s)"
          echo "Skipped:   $skipped_count file(s)"
          echo "Failed:    $failed_count file(s)"
          if [ "$generated_count" -gt 0 ]; then
            echo ""
            echo "Generated files:"
            printf "%b\n" "$generated_files"
          fi
          if [ "$skipped_count" -gt 0 ]; then
            echo ""
            echo "Skipped files:"
            printf "%b\n" "$skipped_files"
          fi
          if [ "$failed_count" -gt 0 ]; then
            echo ""
            echo "Failed files:"
            printf "%b\n" "$failed_files"
          fi

      # メタデータを生成（全てのKVキー）
      - name: Generate metadata
        env:
          THUMBNAIL_BASE_URL: ${{ secrets.THUMBNAIL_BASE_URL }}
        run: |
          node .github/scripts/generate-metadata.mjs . all > metadata-all.json
          echo "Generated metadata for $(cat metadata-all.json | jq -r '."metadata:index".totalCount') articles"

      # Wrangler CLIでKVを更新
      - name: Update Workers KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g wrangler

          # metadata:index を更新
          cat metadata-all.json | jq '."metadata:index"' | \
            wrangler kv key put "metadata:index" \
              --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
              --remote \
              --path=/dev/stdin

          # metadata:months を更新
          cat metadata-all.json | jq '."metadata:months"' | \
            wrangler kv key put "metadata:months" \
              --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
              --remote \
              --path=/dev/stdin

          # 各月のメタデータを更新
          cat metadata-all.json | jq -r 'keys[] | select(startswith("metadata:") and (. != "metadata:index") and (. != "metadata:months"))' | while read key; do
            echo "Updating $key..."
            cat metadata-all.json | jq ".\"$key\"" | \
              wrangler kv key put "$key" \
                --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
                --remote \
                --path=/dev/stdin
          done
      
      # 生成したサムネイルをR2にアップロード
      - name: Upload thumbnails to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          find . -type f -name "thumbnail.png" | while read file; do
            # 例: 2026/02/06/Topic/thumbnail.png
            key=${file#./}
            echo "Uploading $file to R2 as $key..."
            wrangler r2 object put "$R2_BUCKET/$key" --file "$file --remote"
          done

      # HTMLファイルをコミット
      - name: Commit generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "**/slide.html" metadata-all.json
          git add "**/thumbnail.png" || true
          git diff --quiet && git diff --staged --quiet || \
            git commit -m "Generate HTML and metadata [skip ci]"
          git push
