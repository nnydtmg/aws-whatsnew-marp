name: Sync to Cloudflare KV

on:
  workflow_run:
    workflows: ["Convert Marp to HTML"]
    types: [completed]
  push:
    branches: [main]
    paths:
      - '**/*.md'
      - '!**/slide.md'  # slide.mdの変更はmarp-to-html完了後にworkflow_runで処理
  workflow_dispatch: # 手動実行も可能

jobs:
  sync:
    runs-on: ubuntu-latest
    # workflow_runトリガーの場合、成功時のみ実行
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate metadata
        id: metadata
        run: |
          node .github/scripts/generate-metadata.mjs > metadata.json
          echo "Generated metadata:"
          cat metadata.json

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Upload main metadata to KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID}}
        run: |
          wrangler kv key put "metadata:index" \
            --path=metadata.json \
            --namespace-id="$KV_NAMESPACE_ID" \
            --remote
          echo "✓ Main metadata uploaded"

      - name: Upload monthly metadata to KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID}}
        run: |
          node .github/scripts/upload-monthly-metadata.mjs
          echo "✓ Monthly metadata uploaded"

      - name: Notify Worker to clear cache
        env:
          WORKER_URL: ${{ secrets.WORKER_URL }}
          SYNC_SECRET: ${{ secrets.SYNC_SECRET }}
        run: |
          curl -X POST "$WORKER_URL/api/sync" \
            -H "X-Sync-Secret: $SYNC_SECRET" \
            -H "Content-Type: application/json" \
            -d '{"event":"metadata_updated","timestamp":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}' \
            || echo "Warning: Failed to notify worker (this is non-critical)"